---
layout: Kerbeross
title: /Kerberos
permalink: /Kerberos
---

<h1>To do</h1>

<p>Add explanation "ski stations" from the book (+ add in reference).</p>

<h1>Introduction</h1>

<p>This post describes what happens under the hood when a client authenticates to use a service implementing Kerberos authentication.</p>

<h1>Summary of Kerberos negociations</h1>

<p>After a user provides his password to use a service implementing Kerberos authentication, a Ticket Granting Ticket (TGT) is requested, allowing a Ticket Granting Service (TGS) to be requested. This TGS is then used to authorize the user on the application.</p>

<p>These three negociations take place with cryptographic algorithms to avoid unauthorized clients to use the service.</p>

<!-- <h2>1. Client <-> Authentication Server</h2> -->

<p>+-------------+                        +----------------+
|   User's    |   1. TGT negociation   | Authentication |
| workstation | <--------------------> |     Server     |
+-------------+                        +----------------+</p>

<p>After this negociation, client has:
- a TGT (he can't decrypt), with a certain life time, that proves to the TGServer he is who he is
- a key K_{C-TGServer} that he can use to communicate K_S with TGServer</p>

<!-- <h2>2. Client <-> Ticket Granting Server</h2> -->

<p>+-------------+                        +-----------------+
|   User's    |   2. TGS negociation   | Ticket Granting |
| workstation | <--------------------> |     Server      |
+-------------+                        +-----------------+</p>

<p>After this negociation, client has:
- a TGS (he can't decrypt), with a certain life time, that proves to the Service he is who he is
- a key K_{C-S} that he can use to communicate with the service</p>

<!-- <h2>3. Client <-> Service</h2> -->

<p>+-------------+                         +-------------+
|   User's    |     3. Authentication   | Application |
| workstation | (<)-------------------> |   Server    |
+-------------+                         +-------------+</p>

<p>After this negociation, client is authenticated to the service and sends its TGService with each request to prove that he is authorized.</p>

<h1>Terminology</h1>

<h2>Actors</h2>

S = Service implementing Kerberos authentication, provided by a server
C = Client, that would like to use the said service

AS = Authentication Server
TGServer = Ticket Granting Server
KDC = AS + TGServer = Key Distribution Center

<h2>Keys</h2>

<h3>Individual components keys</h3>

K_C = client secret key,  shared between client and AS
K_TGServer = TGServer secret key, shared between AS and TGServer
K_S = service secret key, shared between TGServer and the server providing the service

Note that K_C is generated by hashing (after salting) the password that the user provided on the client machine.
=> Client must have provided the right password for K_C to match with the client key stored in the AS.

<h3>Session keys</h3>

K_{C-TGServer} = TGS session key, shared between client and TGServer during the session
K_{C-S} = Service session key, shared between client and service during the session

<h2>Tickets</h2>

TGT = Ticket Granting Ticket
TGService = Ticket Granting Service

<!-- <h1>Kerberos authentication steps</h1>

Kerberos authentication consists in 3 negociations.

[image wikipedia, ajouter "Negociation 1.", "2.", "3." and "TGT", "TGS"]

<h2>1. Client <-> Authentication Server</h2>

After this negociation, client has:
- a TGT (he can't decrypt), with a certain life time, that proves to the TGServer he is who he is
- a key K_{C-TGServer} that he can use to communicate K_S with TGServer

<h2>2. Client <-> Ticket Granting Server</h2>

After this negociation, client has:
- a TGS (he can't decrypt), with a certain life time, that proves to the Service he is who he is
- a key K_{C-S} that he can use to communicate with the service

<h2>3. Client <-> Service</h2>

After this negociation, client is authenticated to the service and sends its TGService with each request to prove that he is authorized.-->

<h1>Kerberos steps in more details<h1>

<h2>1. Client <-> Authentication Server</h2>

<h3>1.1 Client -> Authentication Server</h3>

Client sends a (plaintext) TGT request to the AS, containing:
- client name/ID
- client IP address
- TGServer name/ID
- requested TGT lifetime

<h3>1.2 Client <- Authentication Server</h3>

AS checks if client is in the KDC database.
If found, AS generates a random session key K_{C-TGServer}.

AS sends the <b>TGT (Ticket Granting Ticket)</b>, a message encrypted with K_TGServer, containing:
- client name/ID
- client IP address
- TGS server name/ID
- TGT lifetime (either the requested one or lower)
- timestamp
- K_{C-TGServer} (TGServer session key)
=> client cannot decrypt this TGT since it doesn't know K_TGS.

AS sends a second message to client, encrypted with K_C (client's secret key), containing:
- TGS server name/ID
- TGT lifetime (either the requested one or lower)
- timestamp
- K_{C-TGServer} (TGServer session key)
=> client can decrypt this message if and only if he has the correct K_C.
This is the case only if the client provided the right password (that is used to generate K_C).
=> The client can get K{C-TGServer} if and only if he provided the right password.

<h2>2. Client <-> Ticket Granting Server</h2>

<h3>2.1 Client -> Ticket Granting Server</h3>

Client sends a (plaintext) TGService request to TGServer containing:
- requested service name/ID
- requested TGService lifetime

Client sends a second (plaintext) message to TGServer, containing:
- Authenticator (see below)
- TGT (obtained at step 2.)

The authenticator consists of this, encrypted with K_{C-TGS}:
- client name/ID
- timestamp

<h3>2.2 Client <- Ticket Granting Server</h3>

TGS checks if the service name/ID is in the KDC database.
If the service is found, TGS decrypts the TGT contained in the second message with K_TGServer.
=> In the decrypted TGT, TGS finds the K{C-TGS} and can decrypt the Authenticator.

TGS now performs several checks:
- compare client name/ID in authenticator and in TGT
- compare timestamp in authenticator and in TGT (to see if they don't differ too much)
- check if TGT is not expired using the TGT lifetime field 
- check that the authenticator is not already in its cache (to avoid replay attacks)
- compare source IP address of client's request to IP address in TGT

TGS generates a random service session key K_{C-S}

Note that TGS has K{C-TGServer} since it can decrypt the TGT with its secret key K_TGserver.

TGS sends the <b>TGS (Ticket Granting Service)</b> to client, a message encrypted with K_S, containing:
- client name/ID
- service name/ID
- client IP address
- timestamp
- TGS lifetime
- K_{C-S} (Service session key)
=> client cannot decrypt this TGS since it doesn't know K_S

TGS sends a second message, encrypted with K_{C-TGS}, containing:
- service name/ID
- timestamp
- TGS lifetime
- K_{C-S}
=> client can decrypt this message since he knows K_{C-TGS}
=> client gets K_{C-S}

<h2>3. Client <-> Service</h2>

<h3>3.1 Client -> Service</h3>

Client sends an <b>Authenticator</b> to the service, a message encrypted with K_{C-S}, containing:
- client name/ID
- timestamp

Client sends the TGS (that it received at step 4., still encrypted) to the service

Service decrypts TGS with its K_S in order to obtain K_{C-S}.

Service decrypts the Authenticator with K_{C-S} that he just obtained.

Service now performs several checks:
- compare client name/ID in authenticator and in TGS
- compare timestamp in authenticator and in TGS (to see if they don't differ too much)
- check if TGS is not expired using the TGS lifetime field
- check that the authenticator is not already in its cache (to avoid replay attacks)
- compare source IP address of client's request to IP address in TGS

<h3>3.2 Client <- Service (optional)</h3>

Service sends an <b>Authenticator</b>, a message encrypted with K_{C-S}, containing:
- service name/ID
- timestamp

Client decrypts service authenticator thanks to K_{C-S}.

<h3>What now?</h3>

Now client is authenticated and can use the service.

Future requests from the client to the service use the TGS as long as it has not expired, as defined in the lifetime attribute.

<h1>sources</h1>

<p>- https://www.roguelynn.com/words/explain-like-im-5-kerberos/
- https://en.wikipedia.org/wiki/Kerberos_(protocol)</p>
